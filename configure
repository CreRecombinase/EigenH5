set -x
set -e

which cmake


#cmake -H. -B_builds\
#-DCMAKE_VERBOSE_MAKEFILE=ON\
#-DCMAKE_BUILD_TYPE=Release\
#-DCONDA_PREFIX="${CONDA_PREFIX}"\
#-DCMAKE_INSTALL_PREFIX=_install\
#-DCMAKE_SHARED_LIBRARY_PREFIX_CXX=""\

rxx=$(R CMD config CXX)
echo "CXX: ${rxx}"
MAKEFLAGS=-j8
rcc=$(R CMD config CC)
echo "CC: ${rcc}"
[[ -z "${CONDA_PREFIX}" ]] && MyVar='' || MyVar="${CONDA_PREFIX}"
cmake -H. -B_builds \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=_install \
    -DCMAKE_FIND_ROOT_PATH=${MyVar} \
    -DCMAKE_CXX_COMPILER=${rxx} \
    -DCMAKE_C_COMPILER=${rcc} \
    -DCMAKE_SHARED_LIBRARY_PREFIX_CXX=""

cmake --build _builds --target install --config Release

# Linux
cp _install/lib/eigenh5.so src/EigenH5.so || echo "Failed: eigenh5.so -> src"

# Mac
#cp _install/lib/eigenh5.dylib src/foocpp.so || echo "Failed: eigenh5.dylib -> src"
